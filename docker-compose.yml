version: "3.9"

services:
  pihole:
    container_name: pihole
    image: pihole/pihole:2024.05.0
    hostname: pihole
    network_mode: host
    environment:
      TZ: ${TZ:?Set your timezone, e.g. Europe/London}
      WEBPASSWORD: ${WEBPASSWORD:?Set a Pi-hole web password}
      FTLCONF_LOCAL_IPV4: ${PIHOLE_IPV4:?Set the Pi-hole IPv4 address}
      DHCP_ACTIVE: "false"
    volumes:
      - ./data/pihole/etc-pihole:/etc/pihole
      - ./data/pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
    restart: unless-stopped

  pihole-exporter:
    container_name: pihole-exporter
    image: ekofr/pihole-exporter:latest
    depends_on:
      - pihole
    networks:
      - monitoring
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PIHOLE_HOSTNAME: ${PIHOLE_HOST:?Set to the Pi-hole host IP}
      PIHOLE_PASSWORD: ${WEBPASSWORD:?Set a Pi-hole web password}
      PIHOLE_PORT: 80
      INTERVAL: 30s
    restart: unless-stopped

  prometheus:
    container_name: prometheus
    image: prom/prometheus:latest
    networks:
      - monitoring
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./data/prometheus:/prometheus
    restart: unless-stopped

  grafana:
    container_name: grafana
    image: grafana/grafana-oss:latest
    user: "472"
    networks:
      - monitoring
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - ./data/grafana:/var/lib/grafana
      - ./config/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./config/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
    restart: unless-stopped

networks:
  monitoring:
    driver: bridge
